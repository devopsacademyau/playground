name: 3M workflow with comment on PR

on:
  pull_request:
    paths:
      - 'chisholm-ray/actions02/**'

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: chisholm-ray/actions02/

    steps:
    - uses: actions/checkout@v2  

    - name: set variables
      id: vars
      run: |
        echo ${{ github.sha }} | head -c 7 > TAG_SHA 
        echo "IMAGEFULLNAME=${{ secrets.CCR_DOCKERU }}/actions02:$(cat TAG_SHA)" >> $GITHUB_ENV

        echo "::set-output name=tag::${IMAGEFULLNAME}"

    - name: docker login 
      env:
        CCR_DOCKERU: ${{ secrets.CCR_DOCKERU }}
        CCR_DOCKERP: ${{ secrets.CCR_DOCKERP }}
      run: |
        make login

    - name: build image
      run: make build

    - name: push image
      run: make push

    outputs:
      dockertag: ${{ steps.vars.outputs.tag }}

  comment_pr:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Comment PR
      uses: thollander/actions-comment-pull-request@v1

      with:
        message: 'Image name ${{ needs.build.outputs.dockertag }} has been pushed to dockerhub'
        GITHUB_TOKEN: ${{ secrets.CCR_GITHUB_TOKEN}}
      